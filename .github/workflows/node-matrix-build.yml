name: nodejs-matrix-builds

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
      inputs:
        exclude-version:
          description: version to be excluded from the build
          required: false
          type: string
          default: 12.x
        exclude-os:
          description: OS to be excluded from the build
          required: false
          type: string
          default: ubuntu-latest
        include-version:
          description: version to be included from the build
          required: false
          type: string
          default: 12.x, 13.x, 14.x, 15.x, 16.x
        include-os:
          description: OS to be included from the build
          required: false
          type: string
          default: ubuntu-latest, windows-latest

jobs:
  nodejs-builds:
    runs-on: ${{ matrix.os }}
    name: Node ${{ matrix.node-version }} on ${{ matrix.os }}
    strategy:
      matrix:
        node-version: ${{ fromJSON(format('["{0}"]', join(github.event.inputs.include-version, '","'))) }}
        os: ${{ fromJSON(format('["{0}"]', join(github.event.inputs.include-os, '","'))) }}
        exclude:
          - node-version: ${{ fromJSON(format('[{0}]', join(github.event.inputs.exclude-version, "','" ))) }}
            os: ${{ fromJSON(format('[{0}]', join(github.event.inputs.exclude-os, "','" ))) }}
          
  steps:
    - name: checkout source code
      uses: actions/checkout@v3

    - name: setup node JS
      uses: actions/setup-node@v4
      with:
          node-version: ${{matrix.node-version}}
          cache: 'npm'

    - name: Verify Node.js version
      run: |
        node --version
        npm --version
        echo "Running on ${{ matrix.os }}"

    - name: Node.js install dep using node packge file
      run: npm install

    - name: run the application
      run: npm start

    - name: run the test
      run: npm test
